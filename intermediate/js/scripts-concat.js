var debugCacheManifest=0;if(debugCacheManifest){var cacheStatusValues=[];cacheStatusValues[0]="uncached";cacheStatusValues[1]="idle";cacheStatusValues[2]="checking";cacheStatusValues[3]="downloading";cacheStatusValues[4]="updateready";cacheStatusValues[5]="obsolete";function logEvent(f){var b,a,c,d;b=(navigator.onLine)?"yes":"no";a=cacheStatusValues[cache.status];c=f.type;d="online: "+b;d+=", event: "+c;d+=", status: "+a;if(c=="error"&&navigator.onLine){d+=" (prolly a syntax error in manifest)"}console.log(d)}var cache=window.applicationCache;cache.addEventListener("cached",logEvent,false);cache.addEventListener("checking",logEvent,false);cache.addEventListener("downloading",logEvent,false);cache.addEventListener("error",logEvent,false);cache.addEventListener("noupdate",logEvent,false);cache.addEventListener("obsolete",logEvent,false);cache.addEventListener("progress",logEvent,false);cache.addEventListener("updateready",logEvent,false);window.applicationCache.addEventListener("updateready",function(){window.applicationCache.swapCache();window.location.reload();console.log("swap cache has been called")},false);setInterval(function(){cache.update()},10000)}$(document).ready(function(){var l=$("body"),m=$("#container"),n=$("#sums"),c=$("#payment_form"),h=$("#filter"),q=$("#time_frame"),k=$("#current_owner"),f={},o=null,g=null,i=[];window.addEventListener("online",function(){l.removeClass("offline").data("internet","online");var u=localStorage.getObject("deletions")||[],v=localStorage.getObject("modifications")||[];if(u.length){var t=u;$.each(u,function(x,w){$.post("ajax/payment.php",w+"&offline=1",function(y){if(y!="ok"){alert(y)}else{t.shift()}})});if(t.length){alert("not all deletions actions have been sent");localStorage.setObject("deletions",t)}else{localStorage.removeItem("deletions")}}if(v.length){var t=v;$.each(v,function(x,w){$.post("ajax/payment.php",w+"&offline=1",function(y){if(y!="ok"){alert(y)}else{t.shift()}})});if(t.length){alert("not all deletions actions have been sent");localStorage.setObject("modifications",t)}else{localStorage.removeItem("modifications")}}d()},true);window.addEventListener("offline",function(){l.addClass("offline").data("internet","offline")},true);if(navigator.onLine){l.removeClass("offline").data("internet","online")}else{l.addClass("offline").data("internet","offline")}$(".form_switch a").click(function(t){t.preventDefault();t.stopPropagation();c.resetForm().addClass("deploy");$("body").click(function(u){c.removeClass("deploy").removeClass("submitting")})});c.submit(function(A){A.preventDefault();if($(this)[0].checkValidity()&&!c.hasClass("submitting")){c.addClass("submitting");var z=$("#paymentDate").val().split("/"),y=new Date(z[2],parseInt(z[1])-1,z[0]),y=(y.getDate()>24?new Date(y.getFullYear(),y.getMonth()+1,1):y),w=y.getMonth()+1,C=y.getFullYear()+"-"+((""+w).length==1?"0"+w:w);var v=false,t=$("#time_frame").find("input[value="+C+"]");if(t.length){if(!t.is(":checked")){$("#time_frame").find("input[value="+C+"]").prop({checked:true}).change()}}else{v=true}var u=q.find(":checkbox:not(.year):checked").map(function(){return this.value}).get().join(","),x=$(":input","#payment_form").serialize()+(!v?"&timeframe="+u:"");if(l.data("internet")=="offline"){var B=localStorage.getObject("modifications")||[];B.push(x+"&owner="+k.val());localStorage.setObject("modifications",B);$("body").unbind("click");c.removeClass("submitting").removeClass("deploy");alert("Cette modification sera prise en compte une fois que vous repasserez en ligne.")}else{$.ajax({url:"ajax/payment.php",data:x,type:"POST",dataType:"json",complete:function(){c.removeClass("submitting")},success:function(F,H,E){c.removeClass("submitting");if(F=="ok"){if(v){window.location.reload()}else{d()}}else{if(F.payments){$("body").unbind("click");c.removeClass("deploy");try{lastModified=E.getResponseHeader("Last-Modified");var D=k.val()+"_"+q.find(":checkbox:not(.year):checked").map(function(){return this.value}).get().join(",");localStorage.setObject(D,{lastModified:lastModified,data:F})
}catch(G){alert(G)}p(F);c.find("datalist, select").loadList();h.find("select").loadList();$(".form_switch:visible a").focus()}else{formErrors(F)}}}})}}}).delegate("input[name=typeFK]","change",function(t){if(this.id=="type_3"){c.find(".ownerChoice").fadeIn()}else{c.find(".ownerChoice:visible").fadeOut()}}).find("fieldset").click(function(t){t.stopPropagation()});$("#formCancel").click(function(){$("body").unbind("click");c.removeClass("deploy").removeClass("submitting").resetForm()});$(document).unbind("keydown").keydown(function(t){if(t.which==65){$("#payment_form:not(.deploy)").resetForm().addClass("deploy")}else{if(t.keyCode==27){if(c.hasClass("deploy")){$("body").unbind("click");c.removeClass("deploy").removeClass("submitting")}}}}).delegate("#amount","keydown",function(t){if(t.which==188){t.preventDefault();$("#amount").val(function(){return this.value+"."})}});c.find("datalist, select").loadList();$("#originFK").change(function(t){if(this.value!=""&&limits[this.value]){$("#currency_"+limits[this.value]).prop({checked:true});$("#amount").focus()}});$("#container").isotope({itemSelector:".item",layoutMode:"fitRows",sortBy:"date",sortAscending:false,getSortData:{date:function(t){return t.data("date")},recipient:function(t){return t.data("recipient")},method:function(t){return t.data("method")},origin:function(t){return t.data("origin")},status:function(t){return t.data("status")},amount:function(t){return parseFloat(t.data("amount"))}}}).delegate(".edit, .fork","click",function(w){w.preventDefault();c.resetForm().addClass("deploy");var v=$(this);if(v.hasClass("edit")){$("#action").val("update")}if(l.data("internet")=="offline"){$("#id").val(v.attr("href"));var t=v.closest(".item"),u=t.attr("class");u.split(" ");$.each(u,function(y,z){if(z=="recurrent"||z=="punctual"){$("#recurrent_"+(z=="recurrent"?1:0)).prop({checked:true})}else{if(z.indexOf("type_")!=-1||z.indexOf("currency_")!=-1||z.indexOf("location_")!=-1){$("#"+z).prop({checked:true})}}});$("#label").val(t.find("dd:eq(1)").text());var x=new Date(t.data("date"));$("#paymentDate").val(x.getDate()+"/"+x.getMonth+"/"+x.getFullYear());$("#comment").val(t.data("comment"));$("#originFK").val($("#originList").children("[data-id="+t.data("origin")+"]").text());$("#amount").val(t.data("amount"));$("#methodFK").val($("#methodList").children("[data-id="+t.data("method")+"]").text());$("#recipientFK").val($("#recipientList").children("[data-id="+t.data("recipient")+"]").text());$("#"+t.data("status")).prop({checked:true});if(v.hasClass("fork")){$("#id").val("")}}else{$.post("ajax/payment.php","action=get&id="+v.attr("href"),function(A){var B=$("textarea"),z=null,y=null;$.each(A,function(C,D){z=$("#"+C);if(!isNaN(parseInt(D))){y=$("#"+C.replace(/FK/,"")+"_"+D)}else{y=null}if(z.length){if(C!="label"&&z.is("[list]")){z.val($("#"+z.attr("list")).children("[data-id="+D+"]").text())}else{if(z.is("textarea")){z.val(B.html(D).text())}else{if(z.is("input[type=date]")){var E=D.split("-");z.val(E[2]+"/"+E[1]+"/"+E[0])}else{z.val(B.html(D).text())}}}}else{if(y.length){y.prop({checked:true})}}});if(v.hasClass("fork")){$("#id").val("")}})}}).delegate(".trash","click",function(v){v.preventDefault();if(confirm("Êtes-vous sûr de supprimer ce paiement ?")){var u=q.find(":checkbox:not(.year):checked").map(function(){return this.value}).get().join(","),w="action=delete&id="+$(this).attr("href")+"&timeframe="+u;if(l.data("internet")=="offline"){var t=localStorage.getObject("deletions")||[];t.push(w+"&owner="+k.val());localStorage.setObject("deletions",t);alert("Cette suppression sera prise en compte une fois que vous repasserez en ligne.");m.isotope("remove",$(this).closest(".item")).isotope("reLayout");r()}else{$.post("ajax/payment.php",w,function(x){if(x.payments){c.find("datalist, select").loadList();h.find("select").loadList();p(x)}else{alert(x)}})}}});$(".sort a").click(function(u){u.preventDefault();var t=$(this).attr("href").substr(1);$("#container").isotope({sortBy:t})});h.delegate("a","click",function(w){w.preventDefault();
var v=$(this),u=v.data("group"),t=v.data("filter");v.closest("section").children("output").text($(this).text());f[u]=t;r(m,f)}).find(".primary").each(function(){$(this).closest("section").children("output").text($(this).text())});h.delegate("select","change",function(w){var v=$(this),u=v.attr("name"),t=v.val();f[u]=t;r(m,f)});$(".next_month a").click(function(x){x.preventDefault();if(confirm("Êtes-vous sûr ?\nAucune vérification ne sera réalisée !")){var t=new Date(),u=new Date(t.getFullYear(),t.getMonth()+1,1),y=u.getFullYear()+"-"+(u.getMonth()+1);var v=false;if($("#time_frame").find("input[value="+y+"]").length){$("#time_frame").find("input[value="+y+"]").pro({checked:true}).change()}else{v=true}var w=q.find(":checkbox:not(.year):checked").map(function(){return this.value}).get().join(",");$.post("ajax/payment.php","action=initNextMonth"+(!v?"&timeframe="+w:""),function(z){if(z=="ok"){if(v){window.location.reload()}}else{if(z.payments){p(z)}else{alert(z)}}})}});$("#time_frame :checkbox").change(function(u){if($(this).hasClass("year")){var v=$(this).is(":checked");var t=$(this).parent().find("ul.filter");t.find(":checkbox").each(function(x,w){w.checked=v})}else{$(this).closest("ul").parent().find(".year").prop({checked:true})}if(!c.hasClass("submitting")){clearTimeout(o);o=setTimeout(function(){d()},500)}});$("#sums").delegate("tbody td:not(.type)","mouseenter",function(){var u=$(this),t=u.parent().children(":not(.type)").index(u);u.siblings(".type").addClass("highlight");u.closest("table").find("thead th.fromto:eq("+t+")").addClass("highlight")}).delegate("tbody td:not(.type)","mouseleave",function(){var u=$(this),t=u.parent().children(":not(.type)").index(u);u.siblings(".type").removeClass("highlight");u.closest("table").find("thead th.fromto:eq("+t+")").removeClass("highlight")}).delegate("tfoot td","mouseenter",function(){var u=$(this),t=u.parent().children("td").index(u);u.siblings("th").addClass("highlight");u.closest("table").find("thead th.fromto:eq("+t+")").addClass("highlight")}).delegate("tfoot td","mouseleave",function(){var u=$(this),t=u.parent().children("td").index(u);u.siblings("th").removeClass("highlight");u.closest("table").find("thead th.fromto:eq("+t+")").removeClass("highlight")});$("body").delegate(".button","click",function(){$(this).blur().addClass("primary").parent().find(".primary").not($(this)).removeClass("primary")});$(".switch_view a").data("view","isotope").click(function(w){var v=$(this),u=["#container","#filter","#time_frame",".sort",".next_month",".form_switch","#calculs"],t=["#chart","#chart_type"],x;v.data("view",$(this).data("view")=="isotope"?"chart":"isotope").toggleClass("isotope chart");x=v.data("view");$.each(u,function(y,z){x=="isotope"?$(z).css("display",""):$(z).css("display","none")});$.each(t,function(y,z){x=="chart"?$(z).css("display","block"):$(z).css("display","none")});if(x=="chart"){$("#chart").height($("body").height()-200);b(null)}else{if(g){g.destroy();g=null}}});$("#chart_type a").click(function(t){t.preventDefault();b(this.rel)});function p(v){n.empty().html(v.sums);var u=$("#forecasts"),w=u.children("h2").detach();u.empty().html(v.forecasts).prepend(w);var t=$("#balances"),w=t.children("h2").detach();t.empty().html(v.balances).prepend(w);if(!$("#paymentListTemplate").data("tmpl")){$("#paymentListTemplate").template("paymentList")}var x=$.tmpl("paymentList",v);m.isotope("remove",m.children(".item")).isotope("reLayout").append(x).isotope("appended",x);r()}function d(){var x=q.find(":checkbox:not(.year):checked").map(function(){return this.value}).get().join(",");if(x==""){return}var v,u=0,t=k.val()+"_"+x;try{v=localStorage.getObject(t);if(v){u=v.lastModified}}catch(w){alert(w)}$.ajax("ajax/payment.php",{data:"action=refresh&timeframe="+x+"&owner="+k.val(),dataType:"json",type:"post",headers:{"If-Modified-Since":u},success:function(z,B,y){if(y.status==200){try{u=y.getResponseHeader("Last-Modified");localStorage.setObject(t,{lastModified:u,data:z})}catch(A){alert(A)}}else{z=v.data
}if(z.payments){p(z)}else{alert(z)}}})}function r(){var t=[],v;for(v in f){t.push(f[v])}m.isotope({filter:t.join("").replace(/\*/g,"")});var u=$(".sort:visible a.primary").attr("href").substr(1);m.isotope({sortBy:u})}Highcharts.theme={colors:["#DDDF0D","#7798BF","#55BF3B","#DF5353","#aaeeee","#ff0066","#eeaaee","#55BF3B","#000066","#FF9900","#097054","#FEB729","#669966","#00275E","#BD2031","#9BE1FB","#FFFF00","#C5EFFD","#990099","#669900","#006295","#FFDE00","#5BC236","#C7EB6E","#D75A20","#F8F2E5","#00FF00"],chart:{backgroundColor:{linearGradient:[0,0,0,400],stops:[[0,"rgb(96, 96, 96)"],[1,"rgb(16, 16, 16)"]]},borderWidth:0,borderRadius:15,plotBackgroundColor:null,plotShadow:false,plotBorderWidth:0},lang:{decimalPoint:".",thousandsSep:"'",loading:"chargement...",months:["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"],weekdays:["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"]},title:{style:{color:"#FFF",font:"16px Lucida Grande, Lucida Sans Unicode, Verdana, Arial, Helvetica, sans-serif"}},subtitle:{style:{color:"#DDD",font:"12px Lucida Grande, Lucida Sans Unicode, Verdana, Arial, Helvetica, sans-serif"}},xAxis:{gridLineWidth:0,lineColor:"#999",tickColor:"#999",labels:{style:{color:"#999",fontWeight:"bold"}},title:{style:{color:"#AAA",font:"bold 12px Lucida Grande, Lucida Sans Unicode, Verdana, Arial, Helvetica, sans-serif"}}},yAxis:{alternateGridColor:null,minorTickInterval:null,gridLineColor:"rgba(255, 255, 255, .1)",lineWidth:0,tickWidth:0,labels:{style:{color:"#999",fontWeight:"bold"}},title:{style:{color:"#AAA",font:"bold 12px Lucida Grande, Lucida Sans Unicode, Verdana, Arial, Helvetica, sans-serif"}}},legend:{itemStyle:{color:"#CCC"},itemHoverStyle:{color:"#FFF"},itemHiddenStyle:{color:"#333"}},labels:{style:{color:"#CCC"}},tooltip:{backgroundColor:{linearGradient:[0,0,0,50],stops:[[0,"rgba(96, 96, 96, .8)"],[1,"rgba(16, 16, 16, .8)"]]},borderWidth:0,style:{color:"#FFF"}},plotOptions:{line:{dataLabels:{color:"#CCC"},marker:{lineColor:"#333"}},spline:{marker:{lineColor:"#333"}},scatter:{marker:{lineColor:"#333"}}},toolbar:{itemStyle:{color:"#CCC"}},navigation:{buttonOptions:{backgroundColor:{linearGradient:[0,0,0,20],stops:[[0.4,"#606060"],[0.6,"#333333"]]},borderColor:"#000000",symbolStroke:"#C0C0C0",hoverSymbolStroke:"#FFFFFF"}},exporting:{buttons:{exportButton:{symbolFill:"#55BE3B"},printButton:{symbolFill:"#7797BE"}}},legendBackgroundColor:"rgba(48, 48, 48, 0.8)",legendBackgroundColorSolid:"rgb(70, 70, 70)",dataLabelsColor:"#444",textColor:"#E0E0E0",maskColor:"rgba(255,255,255,0.3)"};var a=Highcharts.setOptions(Highcharts.theme);var j={chart:{renderTo:"chart",defaultSeriesType:"column"},title:{text:"Sommes selon monnaie, récurrence et type par mois"},xAxis:{categories:[]},yAxis:{title:{text:"Montant"}},tooltip:{formatter:function(){return"<b>"+this.x+'</b><br/><span style="color:'+this.series.color+'">'+this.series.name+"</span>: "+this.y+"<br/>Total: "+this.point.stackTotal}},plotOptions:{column:{stacking:"normal"}},series:[]};var e={chart:{renderTo:"chart",zoomType:"xy",spacingRight:20},title:{text:"Evolution des comptes"},subtitle:{text:document.ontouchstart===undefined?"Sélectionner une partie de la courbe pour zoomer":"Faite glisser votre doigt sur une partie de la courbe pour zoomer"},xAxis:{type:"datetime",maxZoom:14*24*3600*1000,title:{text:null},dateTimeLabelFormats:{day:"%e %b"}},yAxis:{title:{text:"Montant"},startOnTick:false,showFirstLabel:false},legend:{align:"right",verticalAlign:"top",y:20,floating:true,borderWidth:0},tooltip:{shared:true,formatter:function(){var t="<b>"+Highcharts.dateFormat("%A %d %B",this.x)+"</b>";$.each(this.points,function(v,u){t+='<br/><span style="color:'+u.series.color+';">'+u.series.name+"</span>: "+Highcharts.numberFormat(u.y,2,".","'")+" "+i[u.series.name]});return t},},plotOptions:{series:{lineWidth:1,marker:{enabled:false,states:{hover:{enabled:true,radius:5}}},states:{hover:{lineWidth:1}}}},series:[]};
var s={chart:{renderTo:"chart",defaultSeriesType:"column"},title:{text:"Dépenses par bénéficiaire en pourcentage"},xAxis:{categories:[]},yAxis:{min:0,title:{text:"Pourcentage"}},tooltip:{formatter:function(){return"<b>"+this.series.name+"</b>: "+this.y+" "+i[this.series.stackKey.substr(-1)]+" ("+Math.round(this.percentage)+"%)"}},plotOptions:{column:{stacking:"percent"}},series:[]};function b(v){if(v==null){v=$("#chart_type a.primary").attr("rel")}var w,u=0,t=k.val()+"_"+v;try{w=localStorage.getObject(t);if(w){u=w.lastModified}}catch(x){alert(x)}$.ajax("ajax/payment.php",{data:"action=chart&type="+v,dataType:"json",type:"post",headers:{"If-Modified-Since":u},success:function(z,B,y){if(y.status==200){try{u=y.getResponseHeader("Last-Modified");localStorage.setObject(t,{lastModified:u,data:z})}catch(A){alert(A)}}else{z=w.data}if(z.sums){try{if(g){g.destroy()}switch(v){default:case"expense":j.xAxis.categories=z.months;$.each(z.sums,function(C,D){z.sums[C].data=$.map(D.data,function(E){return parseFloat(E)})});j.series=z.sums;g=new Highcharts.Chart(j);break;case"evolution":i=[];e.series=[];$.each(z.sums,function(C,D){e.series.push({name:C,pointInterval:24*3600*1000,pointStart:Date.UTC(2011,1,1),data:$.map(D.amounts,function(E){return parseFloat(E)})});i[C]=D.symbol});g=new Highcharts.Chart(e);break;case"recipient":i=z.currencies;s.xAxis.categories=z.months;$.each(z.sums,function(C,D){z.sums[C].data=$.map(D.data,function(E){return parseFloat(E)})});s.series=z.sums;g=new Highcharts.Chart(s);break}}catch(A){alert(A.message)}}else{alert(z)}}})}d()});$.fn.loadList=function(){return this.each(function(){var a=$(this),b=a.attr("id").replace(/FK$/g,"List"),g=$("<textarea>"),d,c=0;try{d=localStorage.getObject(b);if(d){c=d.lastModified}}catch(f){alert(f)}$.ajax("ajax/loadList.php",{data:"field="+b,dataType:"json",headers:{"If-Modified-Since":c},success:function(k,m,j){if(j.status==200){try{c=j.getResponseHeader("Last-Modified");localStorage.setObject(b,{lastModified:c,data:k})}catch(l){alert(l)}}else{k=d.data;if(a.find("option:gt(0)").length){return}}var i=a.is("datalist");if(i){a.empty()}else{var h=false;if(a.attr("id").search(/Filter/)!=-1&&list.val()!=""){a.data("sav",list.val());h=true}a.find("option:gt(0)").remove()}$.each(k,function(n,e){e=g.html(e).val();if(i){$("<option>",{value:e,text:e,"data-id":n}).appendTo(a)}else{$("<option>",{value:n,text:e}).appendTo(a)}});if(h){a.val(a.data("sav"))}if(a.data("selectedId")){a.val(list.data("selectedId"));a.removeData("selectedId")}}})})};$.fn.resetForm=function(){return this.each(function(){var a=$(this),b=new Date();a.removeClass("deploy").find(":input:visible, #id").each(function(c,d){if(d.type=="radio"){d.checked=false}else{d.value=""}});a.find(".ownerChoice").hide();$("#paymentDate").val((b.getDate()<10?"0"+b.getDate():b.getDate())+"/"+((b.getMonth()+1)<10?"0":"")+(b.getMonth()+1)+"/"+b.getFullYear());$("#recurrent_0").prop({checked:true});$("#type_2").prop({checked:true});$("#action").val("add")})};function formErrors(a){$.each(a,function(c,b){$("#"+b[0]).addClass(b[2]).siblings(".tip").remove();$("#"+b[0]).parent().append($("<span>",{"class":"tip",text:b[1]}))})}String.prototype.formatDate=function(){var a=this.substr(0,10).split("-");return a[2]+"-"+a[1]+"-"+a[0]};String.prototype.timestamp=function(){var b=this.substr(0,10).split("-"),a=new Date(b[0],b[1],b[2]);return a.getTime()};String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.substr(1)};String.prototype.format=function(c,e){var a=this,b="",d="",c=".",f="'";if(arguments[0]!=undefined){c=arguments[0]}if(arguments[1]!=undefined){f=arguments[1]}if(a.indexOf(".")!=-1){d=a.slice(a.lastIndexOf(".")+1,a.length);a=a.slice(0,a.lastIndexOf("."))}if(a.length>3){while(a.length>3){b=a.slice(a.length-3,a.length)+(b.length?f+b:b);a=a.slice(0,a.length-3)}}if(a.length){b=a+(b.length?f+b:b)}if(d.length){b+=c+d}return b};Storage.prototype.setObject=function(a,b){this.setItem(a,JSON.stringify(b))};Storage.prototype.getObject=function(a){return this.getItem(a)&&JSON.parse(this.getItem(a))
};function getValue(b,a){return b[a]}function getSymbol(b,a){return b[a].symbol};